name: TCAI Production Deployment

on:
  push:
    branches: [ main ]
  release:
    types: [created]

env:
  PROJECT_ID: tcai-production-42
  REGION: asia-southeast1 # Bangkok/Singapore for low latency
  GKE_CLUSTER: tcai-main-cluster
  IMAGE_FRONTEND: gcr.io/tcai-production-42/tcai-frontend
  IMAGE_AI_ENGINE: gcr.io/tcai-production-42/tcai-phaya-thai-engine

jobs:
  build-and-push:
    name: Build & Containerize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Google Auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Build Frontend (Next.js)
        run: |
          docker build -t $IMAGE_FRONTEND:${{ github.sha }} -f docker/frontend.Dockerfile .
          docker push $IMAGE_FRONTEND:${{ github.sha }}

      - name: Build AI Engine (Python/Cuda)
        run: |
          docker build -t $IMAGE_AI_ENGINE:${{ github.sha }} -f docker/ai-engine.Dockerfile .
          docker push $IMAGE_AI_ENGINE:${{ github.sha }}

  deploy-to-production:
    name: K8s Production Rollout
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Deploy via Helm
        run: |
          helm upgrade --install tcai-prod ./charts/tcai \
            --namespace production \
            --set frontend.image=$IMAGE_FRONTEND:${{ github.sha }} \
            --set aiEngine.image=$IMAGE_AI_ENGINE:${{ github.sha }} \
            --values charts/tcai/values-production.yaml \
            --atomic --wait